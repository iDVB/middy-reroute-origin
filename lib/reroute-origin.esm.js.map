{"version":3,"file":"reroute-origin.esm.js","sources":["../src/utils/logger.js","../src/utils/cache-service.js","../src/utils/deepmerge.js","../src/ddb.js","../src/index.js"],"sourcesContent":["import debug from 'debug';\nconst log = debug('reroute:log');\nlog.log = console.log.bind(console);\n\nexport default log;\n","import NodeCache from 'node-cache';\n\nclass Cache {\n  constructor(ttlSeconds) {\n    this.cache = new NodeCache({\n      stdTTL: ttlSeconds,\n      checkperiod: ttlSeconds * 0.2,\n      useClones: false,\n    });\n\n    this.ttl = ttlSeconds;\n  }\n\n  get(key, storeFunction) {\n    if (this.ttl > 0) {\n      const value = this.cache.get(key);\n      if (value) {\n        return Promise.resolve(value);\n      }\n    }\n    return storeFunction().then(result => {\n      this.ttl > 0 && this.cache.set(key, result, this.ttl);\n      return result;\n    });\n  }\n\n  del(keys) {\n    this.cache.del(keys);\n  }\n\n  setDefaultTtl(ttl) {\n    this.ttl = ttl;\n    this.ttl === 0 && this.flush();\n  }\n\n  delStartWith(startStr = '') {\n    if (!startStr) {\n      return;\n    }\n\n    const keys = this.cache.keys();\n    for (const key of keys) {\n      if (key.indexOf(startStr) === 0) {\n        this.del(key);\n      }\n    }\n  }\n\n  flush() {\n    this.cache.flushAll();\n  }\n}\n\nexport default Cache;\n","import merge from 'deepmerge';\n\nconst deepmerge = (x, y, { arrayMerge, ...rest } = {}) =>\n  merge(x, y, { ...rest, arrayMerge: combineMerge });\n\nconst all = (arr, { arrayMerge, ...rest } = {}) =>\n  merge.all(arr, { ...rest, arrayMerge: combineMerge });\n\nconst emptyTarget = value => (Array.isArray(value) ? [] : {});\nconst clone = (value, options) => merge(emptyTarget(value), value, options);\nconst combineMerge = (target, source, options) => {\n  const destination = target.slice();\n  source.forEach((e, i) => {\n    if (typeof destination[i] === 'undefined') {\n      const cloneRequested = options.clone !== false;\n      const shouldClone = cloneRequested && options.isMergeableObject(e);\n      destination[i] = shouldClone ? clone(e, options) : e;\n    } else if (options.isMergeableObject(e)) {\n      destination[i] = merge(target[i], e, options);\n    } else if (target.indexOf(e) === -1) {\n      destination.push(e);\n    }\n  });\n  return destination;\n};\n\nexport default deepmerge;\nexport { all };\n","import AWS from 'aws-sdk';\nconst DDB = new AWS.DynamoDB({\n  apiVersion: '2012-08-10',\n  region: 'us-east-1',\n});\n\nexport default DDB;\n","import dotProp from 'dot-prop-immutable';\nimport logger from './utils/logger';\nimport CacheService from './utils/cache-service';\nimport merge from './utils/deepmerge';\nimport DDB from './ddb';\n\nconst S3_SUFFIX = '.s3.amazonaws.com';\nconst ORIGIN_S3_DOTPATH = 'Records.0.cf.request.origin.s3';\n\nconst ttl = 300; // default TTL of 30 seconds\nconst cache = new CacheService(ttl);\n\nconst rerouteOrigin = async (opts = {}, handler, next) => {\n  const { context } = handler;\n  const { request } = handler.event.Records[0].cf;\n  const { origin } = request;\n  const [host] = getHeaderValues(['host'], request.headers);\n  const s3DomainName = origin && origin.s3 && origin.s3.domainName;\n  const originBucket = s3DomainName && s3DomainName.replace(S3_SUFFIX, '');\n\n  const tableSuffix = '-domainmap';\n  const functionSuffix = '-originrequest';\n  const defaults = {\n    functionSuffix,\n    tableSuffix,\n    tableName: getTableFromFunctionName(\n      context.functionName,\n      functionSuffix,\n      tableSuffix,\n    ),\n    cacheTtl: ttl,\n  };\n  const options = merge(defaults, opts);\n  cache.setDefaultTtl(options.cacheTtl);\n\n  logger(`\n    Raw Event:\n    ${JSON.stringify(handler.event)}\n\n    Middleware Options:\n    ${JSON.stringify(options)}\n    ---- Request ----\n    URI: ${request.uri}\n    Host: ${host}\n    Origin: ${s3DomainName}\n    `);\n\n  try {\n    const domainData = await getDomainData(options.tableName, host);\n    logger({ domainData });\n    handler.event = !!domainData\n      ? merge(\n          handler.event,\n          dotProp.set({}, ORIGIN_S3_DOTPATH, {\n            region: domainData.region,\n            domainName: domainData.origin,\n          }),\n        )\n      : handler.event;\n  } catch (err) {\n    logger('Throwing Error for main thread');\n    throw err;\n  }\n\n  return;\n};\n\nexport default opts => ({\n  before: rerouteOrigin.bind(null, opts),\n});\n\n///////////////////////\n// Utils     //\n///////////////////////\nconst getHeaderValues = (paramArr, headers) =>\n  paramArr.map(\n    param => headers[param] && headers[param][0] && headers[param][0].value,\n  );\n\n// from:  us-east-1.marketing-stack-proxy-prod-viewerRequest\n// to:    marketing-stack-proxy-prod-originmap\nconst getTableFromFunctionName = (\n  functionName,\n  functionSuffix,\n  tableSuffix,\n) => {\n  const [rest, stackname] = functionName.match(\n    `^us-east-1\\.(.+)${functionSuffix}$`,\n  );\n  return `${stackname}${tableSuffix}`;\n};\n\nconst getDomainData = (table, host) =>\n  cache.get(`getDomainData_${host}`, () =>\n    DDB.getItem({\n      Key: {\n        Host: {\n          S: host,\n        },\n      },\n      TableName: table,\n    })\n      .promise()\n      .then(data => {\n        logger(`\n      getDomainData: \n      ${JSON.stringify(data)}`);\n        return (\n          data.Item &&\n          data.Item.Origin &&\n          data.Item.Origin.S && {\n            host: data.Item.Host.S,\n            origin: data.Item.Origin.S,\n            region: data.Item.Region.S,\n          }\n        );\n      }),\n  );\n"],"names":["log","debug","console","bind","Cache","constructor","ttlSeconds","cache","NodeCache","stdTTL","checkperiod","useClones","ttl","get","key","storeFunction","value","Promise","resolve","then","result","set","del","keys","setDefaultTtl","flush","delStartWith","startStr","indexOf","flushAll","deepmerge","x","y","rest","merge","arrayMerge","combineMerge","emptyTarget","Array","isArray","clone","options","target","source","destination","slice","forEach","e","i","cloneRequested","shouldClone","isMergeableObject","push","DDB","AWS","DynamoDB","apiVersion","region","S3_SUFFIX","ORIGIN_S3_DOTPATH","CacheService","rerouteOrigin","opts","handler","next","context","request","event","Records","cf","origin","host","getHeaderValues","headers","s3DomainName","s3","domainName","originBucket","replace","tableSuffix","functionSuffix","defaults","tableName","getTableFromFunctionName","functionName","cacheTtl","logger","JSON","stringify","uri","domainData","getDomainData","dotProp","err","before","paramArr","map","param","stackname","match","table","getItem","Key","Host","S","TableName","promise","data","Item","Origin","Region"],"mappings":"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"}